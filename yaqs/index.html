<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YAQS</title>
</head>
<body style="background-color:#f3f3f3;font-family:'Segoe UI',Roboto,sans-serif;">
  <div style="position:fixed;left:8px;top:8px;">
    <div style="font-family:Georgia,'Times New Roman',Times,serif;font-size:24px;font-style:italic;font-weight:600;text-decoration:none;"><a href='#'>YAQS</a></div>
    <div style="font-size:10px;color:#666">Yet Another Qrcode Scanner.</div>
  </div>

  <div style="margin:100px auto;display:flex;flex-flow:column;align-items:center;gap:12px;">
    <label for="file" style="font-size: 16px; color: #333;">Past or Select Image</label>
    <input type="file" id="file" accept="image/*" style="display:none" />
    <canvas></canvas>
    <span>
      <button type="button" id="copyimage">COPY IMAGE</button>
      <button type="button" id="saveimage">SAVE IMAGE</button>
    </span>
    <span>Get or Set Text</span>
    <textarea id="text" placeholder="text" cols="60" rows="3" style="max-width:100%"></textarea>
    <button type="button" id="copytext">COPY TEXT</button>
  </div>

  <script defer type="module">
    import dayjs from 'https://esm.sh/dayjs@1.11.13';
    import jsqr from 'https://esm.sh/jsqr@1.4.0';
    import qrcode from 'https://esm.sh/qrcode@1.5.4';

    const canvasElement = document.querySelector('canvas');
    const textElement = document.querySelector('textarea');

    document.querySelector('button#copyimage').addEventListener('click', () => {
      canvasElement.toBlob(blob => navigator.clipboard.write([new ClipboardItem({ 'image/jpeg': blob })]), 'image/jpeg', 0.9);
    });
    document.querySelector('button#saveimage').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `qrcode-${dayjs().format('YYYYMMDD-hhmmss')}.jpg`;
      canvasElement.toBlob(blob => {
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
      }, 'image/jpeg', 0.9);
    });
    document.querySelector('button#copytext').addEventListener('click', () => {
      window.navigator.clipboard.writeText(textElement.value);
    });

    textElement.addEventListener('keydown', e => {
      if (e.key == 'Enter' && textElement.value) {
        qrcode.toCanvas(canvasElement, textElement.value, e => {
          if (e) {
            console.log(e);
            alert('Something went wrong.');
          }
        });
      }
    });

    document.querySelector('input#file').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => decodeImage(e.target.result);
        reader.readAsDataURL(file);
      }
    });
    document.addEventListener('paste', e => {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => decodeImage(e.target.result);
          reader.readAsDataURL(items[i].getAsFile());
        }
      }
    });

    // NOTE if you are updating this file and redeploying, duplicate and remove comment and deploy to reduce file size

    function decodeImage(imageData) {
      const imageElement = new Image();
      imageElement.onload = async () => {
        const aspectRatio = imageElement.width / imageElement.height;
        if (imageElement.width > window.innerWidth) {
          canvasElement.width = window.innerWidth;
          canvasElement.height = canvasElement.width / aspectRatio;
        } else {
          canvasElement.width = imageElement.width;
          canvasElement.height = imageElement.height;
        }
        const ctx = canvasElement.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(imageElement, 0, 0);
        const imageData = ctx.getImageData(0, 0, imageElement.width, imageElement.height);

        const decodeResult = jsqr(imageData.data, imageData.width, imageData.height);
        if (decodeResult) {
          console.log(decodeResult);
          textElement.value = decodeResult.data || '(no text data)';
          const { topLeftCorner, topRightCorner, bottomRightCorner, bottomLeftCorner } = decodeResult.location;
          ctx.beginPath();
          const scaleX = canvasElement.width / imageElement.width;
          const scaleY = canvasElement.height / imageElement.height;
          ctx.moveTo(topLeftCorner.x * scaleX, topLeftCorner.y * scaleY);
          ctx.lineTo(topRightCorner.x * scaleX, topRightCorner.y * scaleY);
          ctx.lineTo(bottomRightCorner.x * scaleX, bottomRightCorner.y * scaleY);
          ctx.lineTo(bottomLeftCorner.x * scaleX, bottomLeftCorner.y * scaleY);
          ctx.closePath();
          ctx.strokeStyle = 'red';
          ctx.lineWidth = 2;
          ctx.stroke();
        } else {
          textElement.value = '(no qrcode found in image)';
        }

        // // zxing-js was tried for detecting multiple qrcode in one image,
        // // but also does not support that, so keep using jsqr because package size (cdn) is a lot smaller
        // import * as zxing from 'https://esm.sh/@zxing/library@0.21.3';
        // const reader = new zxing.BrowserQRCodeReader();
        // reader.decodeFromImage(imageElement).then(result => {
        //   console.log(result);
        // }, e => {
        //   console.error(e);
        // });

        // // qr-scanner-wechat is able to use an opencv model to detect qrcode locations and decode multiple qrcodes,
        // // https://github.com/antfu/qr-scanner-wechat/blob/main/src/index.ts
        // // but this package does not have document and seems not exposing the functionality to decode multiple,
        // // so the investigation ends here and I can keep this single-html application nice and small,
        // // if you are interested in future, see also https://docs.opencv.org/4.x/d5/d04/classcv_1_1wechat__qrcode_1_1WeChatQRCode.html
        // import * as qswe from 'https://esm.sh/qr-scanner-wechat@0.1.3';
        // const result = await qswe.scan(imageElement);
        // console.log(result);
      };
      imageElement.src = imageData;
    }

    // backup and story section

    // first, find library, QR code scanning is a lot less popular than QR code generation in search results
    // - Stage 1, used packages
    //   - https://github.com/soldair/node-qrcode the package with exact name on npm, used in fine, is purely for generation
    // - Stage 2, full featured solutions
    //   - https://github.com/nimiq/qr-scanner is full featured library and too large, it uses a fork of jsqr
    //   - https://github.com/mebjas/html5-qrcode is full feature library and too large, it use a bundled zxing-js in source code
    // - Stage 3, implementations
    //   - https://github.com/cozmo/jsQR is old and inactive
    //   - https://github.com/danimoh/jsQR is a fork of previous jsqr and upgraded some, is old and inactive
    //   - https://github.com/LazarSoft/jsqrcode is too old and inactive, is listed as a port by zxing
    //   - https://github.com/zxing-js/library is in maintenance mode, is listed as a port by zxing
    // - Stage 3.5, rust implementations
    //   - https://github.com/WanzenBug/rqrr is not no_std (not easy to wasm)
    //   - https://github.com/piderman314/bardecoder is not no_std
    //   - https://github.com/dignifiedquire/quircs is old and inactive, is a port of quirc, is not no_std
    //   - https://github.com/rxing-core/rxing is listed as a port by zxing, has a wasm port!
    // - Alternative implementations that are not js/ts/rust
    //   - https://github.com/zxing/zxing is java and in maintenance mode
    //   - https://github.com/dlbeer/quirc is c/c++

    // second, try,
    // - rxing-wasm does not work, how do I reference a wasm library in single-html application?
    // - jsqr cannot scan qq and wechat generated qrcode, but some online service does, e.g. https://qrscanner.net/
    // - jsqrcode also does not work
    //   ```ts
    //   import fs from 'node:fs/promises';
    //   import { deploy } from './components/sftp.ts';
    //   const files: [string, string][] = [];
    //   for (const filename of await fs.readdir('../jsqrcode/src')) {
    //       files.push([`../jsqrcode/src/${filename}`, `public/yaqs/${filename}`]);
    //   }
    //   const assets = await Promise.all(files.map(async ([l, r]) => ({ data: await fs.readFile(l), remote: r })));
    //   await deploy(assets);
    //   ```
    // - ai indicate me to zxing.DecoderHintTypes.TRY_HARDER, so try zxing-js
    // - jsqr and zxing-js both cannot scan multiple qrcode images and both work well on normal qrcode images,
    //   choose jsqr because of package size
    // - find qrcode-scanner-wechat by this issue https://github.com/zxing-js/library/issues/571, decided to end project
    //
    // if you read here, I can tell you this is likely to be hosted on https://freskyz.com/yaqs/index.html
  </script>
</body>
</html>